#jinja2: trim_blocks: True, lstrip_blocks: True
#!/bin/sh
# =============================================================================
# OS Login Information Display Script
# =============================================================================
# This script displays system information, resources status, and welcome
# message when a user logs into the system.
# Last Modified: Generated by Ansible on {{ ansible_facts['date_time']['date'] }}
# =============================================================================

# Basic color definitions
C_DEFAULT='\033[0m'
C_RED='\e[0;31m'
C_GREEN='\e[0;32m'
C_YELLOW='\e[0;33m'
C_BLUE='\e[0;34m'
C_CYAN='\e[0;36m'
C_WHITE='\e[1;37m'
C_BOLD='\e[1m'

# Check for bc availability
if command -v bc >/dev/null 2>&1; then
  HAS_BC=1
else
  HAS_BC=0
fi

# Display the banner
/usr/bin/echo -en "${C_BLUE}"
/usr/bin/cat /etc/profile.d/banner
/usr/bin/echo -e "${C_DEFAULT}"

# System Information Section
/usr/bin/echo ""
/usr/bin/echo -e "${C_CYAN}${C_BOLD}┌─────────────── SYSTEM INFORMATION ──────────────┐${C_DEFAULT}"
/usr/bin/echo ""

/usr/bin/echo -e "  ${C_WHITE}OS version             :${C_DEFAULT} $(cat /etc/os-release | grep PRETTY | cut -d '=' -f 2 | tr -d '"')"
/usr/bin/echo -e "  ${C_WHITE}OS family              :${C_DEFAULT} $(cat /etc/redhat-release)"
/usr/bin/echo -e "  ${C_WHITE}Kernel version         :${C_DEFAULT} $(uname -r)"
/usr/bin/echo -e "  ${C_WHITE}IPv4 Address(es)       :${C_DEFAULT} $(/usr/sbin/ip -4 -o addr show scope global | awk '{print $4}' | cut -d/ -f1 | tr '\n' ' ')"
/usr/bin/echo -e "  ${C_WHITE}Running Processes      :${C_DEFAULT} $(ps ax | wc -l | tr -d ' ')"

# Resource utilization information
MEM_USED=$(free -m | grep Mem | awk '{print $3}')
MEM_TOTAL=$(free -m | grep Mem | awk '{print $2}')
MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))

# Color code memory based on usage
if [ $MEM_PERCENT -gt 90 ]; then
  MEM_COLOR="${C_RED}"      # Critical
elif [ $MEM_PERCENT -gt 70 ]; then
  MEM_COLOR="${C_YELLOW}"   # Warning
else
  MEM_COLOR="${C_GREEN}"    # Normal
fi

/usr/bin/echo -e "  ${C_WHITE}RAM (used/total)       :${C_DEFAULT} ${MEM_USED}MB/${MEM_TOTAL}MB ${MEM_COLOR}(${MEM_PERCENT}%)${C_DEFAULT}"
/usr/bin/echo -e "  ${C_WHITE}Disk usage (/)         :${C_DEFAULT} $(df -h / | awk 'NR==2 {print $5 " used (" $3 "/" $2 ")"}')"
/usr/bin/echo -e "  ${C_WHITE}CPU cores              :${C_DEFAULT} $(nproc)"
/usr/bin/echo -e "  ${C_WHITE}Users logged in        :${C_DEFAULT} $(users | wc -w)"

# Load average information
LOAD_1=$(cat /proc/loadavg | cut -d ' ' -f 1)
LOAD_5=$(cat /proc/loadavg | cut -d ' ' -f 2)
LOAD_15=$(cat /proc/loadavg | cut -d ' ' -f 3)
CPU_CORES=$(nproc)

# Color code load average if bc is available
if [ "$HAS_BC" -eq 1 ]; then
  if [ $(echo "${LOAD_1} > ${CPU_CORES}" | bc) -eq 1 ]; then
    LOAD_COLOR="${C_RED}"       # Overloaded
  elif [ $(echo "${LOAD_1} > ${CPU_CORES} * 0.7" | bc) -eq 1 ]; then
    LOAD_COLOR="${C_YELLOW}"    # High load
  else
    LOAD_COLOR="${C_GREEN}"     # Normal load
  fi
else
  LOAD_COLOR="${C_WHITE}"
  /usr/bin/echo -e "  ${C_YELLOW}[INFO] 'bc' not found: load average color-coding disabled.${C_DEFAULT}"
fi

/usr/bin/echo -e "  ${C_WHITE}System load            :${C_DEFAULT} ${LOAD_COLOR}${LOAD_1}${C_DEFAULT} ${LOAD_5} ${LOAD_15}"
/usr/bin/echo -e "  ${C_WHITE}Uptime                 :${C_DEFAULT} $(uptime -p)"
/usr/bin/echo -e "  ${C_WHITE}Date                   :${C_DEFAULT} $(date +"%A, %e %B %Y, %r")"
/usr/bin/echo -e "\n${C_CYAN}${C_BOLD}└────────────────────────────────────────────────┘${C_DEFAULT}"

# Welcome message section
/usr/bin/echo ""
/usr/bin/echo -e "${C_CYAN}${C_BOLD}┌──────────────────── WELCOME ───────────────────┐${C_DEFAULT}"
/usr/bin/echo ""
/usr/bin/echo -e "  ${C_WHITE}Hostname     :${C_DEFAULT} ${C_RED}$(hostname -f)${C_DEFAULT}"
/usr/bin/echo -e "  ${C_WHITE}System admin :${C_DEFAULT} ${C_RED}{{ os_customize_system_admin_mail }}${C_DEFAULT}"
/usr/bin/echo ""
/usr/bin/echo -e "${C_CYAN}${C_BOLD}└────────────────────────────────────────────────┘${C_DEFAULT}"

# Last login information
/usr/bin/echo ""
/usr/bin/echo -e "${C_CYAN}${C_BOLD}┌──────────── LAST LOGIN INFORMATION ────────────┐${C_DEFAULT}"
/usr/bin/echo ""
/usr/bin/lastlog -u $(whoami) | tail -n 1
/usr/bin/echo ""
/usr/bin/echo -e "${C_CYAN}${C_BOLD}└────────────────────────────────────────────────┘${C_DEFAULT}"
/usr/bin/echo ""
