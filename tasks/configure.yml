---
# =============================================================================
# Ansible Role: OS Customize - Configuration Tasks
# =============================================================================
# These tasks handle the configuration of OS customization, including banner,
# login message, package installation, timezone setup, service management,
# and user group configuration.
#
# Flow:
# 1. Deploy login banner
# 2. Deploy login message script
# 3. Install additional packages (optional)
# 4. Configure system timezone (optional)
# 5. Disable motd-news.timer service (optional)
# 6. Create SSH users group (optional)
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Deploy Login Banner
# -----------------------------------------------------------------------------
- name: OS_Customize | template | Deploy welcome banner
  become: true
  ansible.builtin.template:
    src: "templates/banner.j2"
    dest: "{{ os_customize_welcome_banner_path }}"
    owner: root
    group: root
    mode: "0644"

# -----------------------------------------------------------------------------
# 2. Deploy Login Message Script
# -----------------------------------------------------------------------------
- name: OS_Customize | template | Deploy welcome message script
  become: true
  ansible.builtin.template:
    src: "templates/scripts/login_{{ ansible_facts['os_family'] | lower }}.sh.j2"
    dest: "{{ os_customize_welcome_script_path }}"
    owner: root
    group: root
    mode: "0644"

# -----------------------------------------------------------------------------
# 3. Install Additional Packages (Optional)
# -----------------------------------------------------------------------------
- name: OS_Customize | package | Install additional packages
  become: true
  ansible.builtin.package:
    name: "{{ item }}"
    update_cache: true
    state: present
  with_items: "{{ os_customize_additional_packages }}"
  when: >
    os_customize_configure_additional_packages | default(false)

# -----------------------------------------------------------------------------
# 4. Configure System Timezone (Optional)
# -----------------------------------------------------------------------------
- block:
    - name: OS_Customize | shell | Check if timezone is available
      ansible.builtin.shell: timedatectl list-timezones | grep -q "^{{ os_customize_timezone }}$"
      register: timezone_available
      changed_when: false
      failed_when: false
      check_mode: false

    - name: OS_Customize | fail | Fail if timezone is not available
      ansible.builtin.fail:
        msg: "The timezone {{ os_customize_timezone }} is not available on this system"
      when: >
        timezone_available.rc != 0

    - name: OS_Customize | timezone | Set system timezone
      community.general.timezone:
        name: "{{ os_customize_timezone }}"
      register: timezone_changed
      become: true

    - name: OS_Customize | debug | Show timezone change notification
      ansible.builtin.debug:
        msg: "Timezone changed to {{ os_customize_timezone }}"
      when: >
        timezone_changed.changed
  when: >
    os_customize_configure_timezone | default(false)

# -----------------------------------------------------------------------------
# 5. Disable MOTD News Service (Optional)
# -----------------------------------------------------------------------------
- name: OS_Customize | stat | Check if motd-news.timer exists
  ansible.builtin.stat:
    path: "/lib/systemd/system/motd-news.timer"
  register: _motd_news_timer_
  become: true
  when: >
    os_customize_disable_motd_news | default(false)

- name: OS_Customize | systemd | Disable and stop motd-news.timer
  ansible.builtin.systemd:
    name: motd-news.timer
    state: stopped
    enabled: false
    masked: true
  when: >
    os_customize_disable_motd_news | default(false) and
    _motd_news_timer_.stat.exists | default(false)
  become: true

# -----------------------------------------------------------------------------
# 6. Create SSH Users Group (Optional)
# -----------------------------------------------------------------------------
- name: OS_Customize | group | Create dedicated SSH users group
  ansible.builtin.group:
    name: "{{ os_customize_ssh_group_name }}"
    gid: "{{ os_customize_ssh_group_gid }}"
    state: present
    system: false
  when: >
    os_customize_configure_ssh_group | default(false)
  become: true
